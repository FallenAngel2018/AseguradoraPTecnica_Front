@page
@model AseguradoraPTecnica_Front.Pages.Cliente.IndexModel
@{
    ViewData["Title"] = "Gestión de Clientes";
}


<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-6">
            <h2>Lista de Clientes</h2>
        </div>
        <div class="col-md-6 text-end">
            <button type="button" class="btn btn-success me-2" id="btnCargarArchivo">
                <i class="bi bi-upload"></i> Ingresar Múltiples Clientes
            </button>
            <button type="button" class="btn btn-primary" id="btnNuevoCliente">
                <i class="bi bi-plus-circle"></i> Nuevo Cliente
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div id="tablaClientesContainer">
                        @await Html.PartialAsync("_TablaClientes", Model.Clientes)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para formulario de cliente -->
<div class="modal fade" id="modalCliente" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalClienteLabel">Nuevo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
            </div>
        </div>
    </div>
</div>

<!-- Modal para cargar archivo -->
<div class="modal fade" id="modalCargarArchivo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cargar Archivo de Clientes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCargarArchivo" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label for="archivoClientes" class="form-label">
                            Seleccione archivo (XLSX o TXT)
                        </label>
                        <input type="file"
                               class="form-control"
                               id="archivoClientes"
                               name="archivo"
                               accept=".xlsx,.txt">
                        <div class="form-text">
                            Formatos permitidos: .xlsx, .txt (máximo 5MB)
                        </div>
                    </div>
                    <div id="previewArchivo" class="alert alert-info d-none">
                        <strong>Archivo seleccionado:</strong>
                        <p class="mb-0" id="infoArchivo"></p>
                    </div>
                    <div id="errorArchivo" class="alert alert-danger d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSubirArchivo">
                    <i class="bi bi-upload"></i> Subir Archivo
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            cargarClientes();

            $('#btnNuevoCliente').click(function() {
                cargarFormularioCliente();
            });

            // ABRIR MODAL DE CARGA DE ARCHIVO
            $('#btnCargarArchivo').click(function() {
                $('#formCargarArchivo')[0].reset();
                $('#previewArchivo').addClass('d-none');
                $('#errorArchivo').addClass('d-none');
                $('#modalCargarArchivo').modal('show');
            });

            $('#archivoClientes').change(function() {
                var archivo = this.files[0];
                $('#errorArchivo').addClass('d-none');

                // Si NO hay archivo (usuario canceló), solo limpiar
                if (!archivo) {
                    $('#previewArchivo').addClass('d-none');
                    return;
                }

                // Validar extensión
                var extension = archivo.name.split('.').pop().toLowerCase();
                if (extension !== 'xlsx' && extension !== 'txt') {
                    $('#errorArchivo')
                        .text('Solo se permiten archivos .xlsx o .txt')
                        .removeClass('d-none');
                    this.value = '';
                    $('#previewArchivo').addClass('d-none');
                    return;
                }

                // Validar tamaño (5MB)
                if (archivo.size > 5 * 1024 * 1024) {
                    $('#errorArchivo')
                        .text('El archivo no debe superar los 5MB')
                        .removeClass('d-none');
                    this.value = '';
                    $('#previewArchivo').addClass('d-none');
                    return;
                }

                // Mostrar info del archivo
                var tamanoFormateado = formatearTamanoArchivo(archivo.size);

                console.log("Archivo seleccionado:", archivo.name);
                console.log("Tamaño:", tamanoFormateado);

                $('#infoArchivo').html(
                    '<strong>Nombre:</strong> ' + archivo.name + '<br>' +
                    '<strong>Tamaño:</strong> ' + tamanoFormateado + '<br>' +
                    '<strong>Tipo:</strong> ' + extension.toUpperCase()
                );
                $('#previewArchivo').removeClass('d-none');
            });


            $('#btnSubirArchivo').click(function() {
                console.log("========== BOTÓN SUBIR CLICKEADO ==========");

                var archivo = $('#archivoClientes')[0].files[0];

                if (!archivo) {
                    console.log("No hay archivo seleccionado");
                    $('#errorArchivo')
                        .text('Debe seleccionar un archivo')
                        .removeClass('d-none');
                    return;
                }

                console.log("Archivo válido, preparando FormData...");
                console.log("Nombre:", archivo.name);
                console.log("Tamaño:", archivo.size);

                var formData = new FormData();
                formData.append('archivo', archivo);

                console.log("FormData creado, verificando token...");
                var token = $('input[name="__RequestVerificationToken"]').val();
                console.log("Token:", token ? "Encontrado" : "NO ENCONTRADO");

                $('#btnSubirArchivo').prop('disabled', true).html(
                    '<span class="spinner-border spinner-border-sm me-2"></span>Subiendo...'
                );

                console.log("Iniciando petición AJAX...");

                $.ajax({
                    url: '/Cliente/Index?handler=CargarArchivo',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'RequestVerificationToken': token
                    },
                    beforeSend: function() {
                        console.log("AJAX beforeSend ejecutado");
                    },
                    success: function(response) {
                        console.log("AJAX SUCCESS:", response);
                        if (response.success) {
                            alert(response.message);
                            $('#modalCargarArchivo').modal('hide');
                            cargarClientes();
                        } else {
                            $('#errorArchivo')
                                .text('Error: ' + response.message)
                                .removeClass('d-none');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log("========== AJAX ERROR ==========");
                        console.log("Status:", status);
                        console.log("Error:", error);
                        console.log("Response:", xhr.responseText);
                        console.log("Status Code:", xhr.status);
                        console.log("================================");

                        var mensajeError = xhr.responseJSON?.message || error;
                        $('#errorArchivo')
                            .text('Error al subir el archivo: ' + mensajeError)
                            .removeClass('d-none');
                    },
                    complete: function() {
                        console.log("AJAX COMPLETE ejecutado");
                        $('#btnSubirArchivo').prop('disabled', false).html(
                            '<i class="bi bi-upload"></i> Subir Archivo'
                        );
                    }
                });
            });




        });

        function cargarClientes() {
            $.ajax({
                url: '/Cliente/Index?handler=ActualizarTablaParcial',
                type: 'GET',
                success: function(html) {
                    $('#tablaClientesContainer').html(html);  // Actualiza el div con nuevo HTML
                },
                error: function () {
                    alert('Error al cargar la tabla de clientes');
                }
            });
        }


        function formatearTamanoArchivo(bytes, decimales = 2) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimales < 0 ? 0 : decimales;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

    </script>
}
